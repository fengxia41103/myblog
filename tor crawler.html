<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta
      name="viewport"
      content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
    />

    <meta name="description" content="" />
    <meta name="author" content="" />

    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"
    />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/monokai-sublime.min.css" integrity="sha512-ade8vHOXH67Cm9z/U2vBpckPD1Enhdxl3N05ChXyFx5xikfqggrK4RrEele+VWY/iaZyfk7Bhk6CyZvlh7+5JQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/css/materialize.min.css"
    />

    <link rel="stylesheet" href="https://fengxia41103.github.io/myblog/theme/css/my.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
            integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>



    <title>Be Care Free</title>
  </head>

  <body>
    <header id="mypage-index">
      <a href="https://fengxia41103.github.io/myblog/">Be Care Free </a>

      <a href="https://fengxia41103.github.io/myblog/about.html"> . About </a>
      <a href="https://fengxia41103.github.io/myblog/lei.html"> . 夏雷 </a>
      <a href="https://fengxia41103.github.io/myblog/project euler.html"> . Project Euler </a>
      <a href="https://fengxia41103.github.io/myblog/quote.html"> . Quote </a>
      <a href="https://fengxia41103.github.io/myblog/resume.html"> . Resum&eacute; </a>
      <a href="https://fengxia41103.github.io/myblog/search.html"> . Search </a>
      <a href="https://fengxia41103.github.io/myblog/slides.html"> . Impression </a>
    </header>
    <!-- end of block navbar -->

    <div class="split-screen">
      <div class="split-left-pane">
<!-- <video autoplay muted loop id="myVideo">
     <source src="downloads/polina.mp4" type="video/mp4" />}
     </video>
-->
      </div>

      <div class="split-right-pane">
        <div id="content" class="container">
<article>
   <div>
    <i class="fa fa-calendar" style="opacity: 0.5">&nbsp;</i>
    2015-03-04


    <a class="wave-effect" href="dev.html">
      <i class="fa fa-folder-open-o"></i>
      dev
    </a>

    <a class="wave-effect" href="tag-dev.html">
      <i class="fa fa-tag"></i>
      dev
    </a>

    <h1 class="myhighlight">Crawler, TOR, and be a good web citizen</h1>
  </div>

  <ol id="toc" class="row"></ol>

  <div>
    <div id="article-content">
      <p><p>Many projects I have done involved harvesting data from
public sites. Data crawling is an exciting business. On one hand, it
is easy to develop a crawler these days. In the Python world,
plenty tutorials will show you how to build
a simple crawler using the <a href="https://docs.python.org/2/library/urllib.html">Python urllib</a>,
or building upon some more sophisticate tool like
<a href="http://doc.scrapy.org/en/latest/intro/tutorial.html">Scrapy</a>.</p>
<figure class="s12 center">
  <img src="images/regular_expressions.png"/>
  <figcaption>Fun with regular expression</figcaption>
</figure>

<p>But before carried away by the fun and the power,
let's lay down a ground rule &mdash; to respect
 peer server and try hard being a good web citizen.
We surely learned a few lessons here. So please
take notes and hopefully you won't fall into the same pit.</p>
<h1>Banned</h1>
<p>We used to joke about this &mdash; if you haven't been banned by a server,
you haven't hit it hard enough. Well, we were banned.</p>
<p>Our first version was a simple urllib based agent and could be run
in multiprocessing mode. Target was a public site run
by a small startup firm, which by rumor consisted mostly of
developers, too. So we took this on almost like an arm race.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">urllib3</span><span class="w"> </span><span class="kn">import</span> <span class="n">PoolManager</span><span class="p">,</span> <span class="n">Retry</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">,</span> <span class="n">ProxyManager</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PlainUtility</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user_agent</span> <span class="o">=</span> <span class="s1">&#39;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.7) Gecko/2009021910 Firefox/3.0.7&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">user_agent</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_url</span> <span class="o">=</span> <span class="s1">&#39;http://icanhazip.com/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gkp&#39;</span><span class="p">)</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span><span class="n">connect</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">redirect</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">PoolManager</span><span class="p">(</span>
            <span class="mi">10</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mf">30.0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">current_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_url</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;status </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</code></pre></div>

<p>We kicked off the crawler in multiprocessing mode (between 200-300
subprocesses) and sat back to watch data pouring in, until
a <code>403 forbidden</code>, ban!
Needless to say, the server must have experienced a trigger event which
prompted the action. What could it be?</p>
<p>First, load. We suspected the load we were generating put us on the
radar. This was a public site who claimed a over three million live
daily users. However, I have always viewed such information with a
grain of salt. So in this case, we guessed those million members were
certainly not clicking at the same time as we were, and that site was
likely hosted on a budget server as many startups have done. With this
consideration, one measure to implement &mdash; throttling (and if you
have a website, don't blow up your user number to make it look too good
to be True, unless you are ready to handle the hits.)</p>
<p>Further, from the time
we were hitting the server to the time the ban came in, a few days
have elapsed. So the reaction was likely taken by a manual intervention
instead of a computerized protection. This is a security hazard on their
end.</p>
<p>Last, we moved to a different wifi access and used the same code, it
went through without a glitch. So another thing became clear, the
defense was IP based, which meant all computers in our office were
helpless now because they shared the same outbound IP.</p>
<p>A few possibilities to resolve this. First, moving around <em>free</em> wifi.
But that is just not nice. Crossed off the list with a 100% vote.
Second, use a VPN. This is a good and common approach. We could use
either an in-house server or a commercial one. But that's too, "boring",
said one developer. So after a few
tries, we ended up with something quite interesting, simple yet
powerful.</p>
<p>Besides the old school <code>PlainUtility</code>, I have introduced
two upgrades &rarr; <code>TorUtility</code> and <code>SeleniumUtility</code>. Both
added a layer of indirection to the puzzle, but also a layer of protection.</p>
<h1>TOR</h1>
<p>First layer added to our stack is to use
<a href="https://www.torproject.org/">TOR</a> network as our proxy to
serve request. Further, because TOR service is a socket proxy, not a
HTTP proxy, we installed another layer, <a href="https://www.privoxy.org/">privoxy</a> in between to connect the two.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TorUtility</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user_agent</span> <span class="o">=</span> <span class="s1">&#39;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.7) Gecko/2009021910 Firefox/3.0.7&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">user_agent</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_url</span> <span class="o">=</span> <span class="s1">&#39;http://icanhazip.com/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gkp&#39;</span><span class="p">)</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span><span class="n">connect</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">redirect</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">ProxyManager</span><span class="p">(</span>
            <span class="s1">&#39;http://localhost:8118/&#39;</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mf">60.0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">renewTorIdentity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passAuth</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">9051</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;AUTHENTICATE &quot;</span><span class="si">{0}</span><span class="s1">&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">passAuth</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;250&#39;</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;signal NEWNYM</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;250&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Identity renewed&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;response 2:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">resp</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;response 1:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">resp</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t renew identity: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">renew_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Controller</span><span class="o">.</span><span class="n">from_port</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">9051</span><span class="p">)</span> <span class="k">as</span> <span class="n">controller</span><span class="p">:</span>
            <span class="n">controller</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;natalie&#39;</span><span class="p">)</span>
            <span class="n">controller</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">Signal</span><span class="o">.</span><span class="n">NEWNYM</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="s1">&#39;Renew TOR IP: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renew_connection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;status </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">current_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_url</span><span class="p">)</span>
</code></pre></div>

<p>Now, with the help of the TOR, we are browsing
internet with <em>anonymity</em>. TOR maintains a pool
of IP addresses, but a renew request does not guarantee to generate
a new IP. On top of this, some IPs were probably located on the moon because
a request took <em>forever</em>, which on our end were a flashing timeout messages across
screen. Internally we maintain a life counter on a connection
and renew it when counter is up so we could return the IP back to the IP.</p>
<h2>TOR config</h2>
<p>The key to config the TOR was to enable <code>ControlPort</code> and set up <code>HashedControlPassword</code>.
The password would be used when sending request to the local TOR service such as renewing a connection. TOR
service would in turn pass that on to TOR network on our behalf.</p>
<div class="highlight"><pre><span></span><code>In<span class="w"> </span>/etc/tor/torrc:

<span class="c1">## The port on which Tor will listen for local connections from Tor</span>
<span class="c1">## controller applications, as documented in control-spec.txt.</span>
ControlPort<span class="w"> </span><span class="m">9051</span>

<span class="c1">## If you enable the controlport, be sure to enable one of these</span>
<span class="c1">## authentication methods, to prevent attackers from accessing it.</span>
HashedControlPassword<span class="w"> </span><span class="m">16</span>:872860B76453A77D60CA2BB8C1A7042072093276A3D701AD684053EC4C
</code></pre></div>

<p>Password is created using <a href="https://www.torproject.org/docs/tor-manual.html.en">TOR commandline</a>.</p>
<h2>Privoxy config</h2>
<p>In <code>/etc/privoxy/config</code>, we set up a receiving port and a forwarding port.
Forwarding port was set to 9050 as that's the default listening port by
the TOR service.</p>
<div class="highlight"><pre><span></span><code>listen-address<span class="w">  </span>localhost:8118
forward-socks5<span class="w">   </span>/<span class="w">   </span><span class="m">127</span>.0.0.1:9050
</code></pre></div>

<h1>Phantom</h1>
<p>Now with the link between us and the target out of the way, we wanted
to change our agent from a urllib brute force to a nicer consumer.
Our goal was to drive a <em>real</em> web browser so our reading of the site
is no different from a real user.
Tapped into our experience with automated web testing, <a href="http://phantomjs.org/">PhantomJS</a>
and <a href="http://www.seleniumhq.org/">Selenium</a> were a natural choice for the job.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">selenium</span><span class="w"> </span><span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">selenium.webdriver.common.desired_capabilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">DesiredCapabilities</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SeleniumUtility</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_tor</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_url</span> <span class="o">=</span> <span class="s1">&#39;http://icanhazip.com/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gkp&#39;</span><span class="p">)</span>

        <span class="n">dcap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DesiredCapabilities</span><span class="o">.</span><span class="n">PHANTOMJS</span><span class="p">)</span>
        <span class="n">dcap</span><span class="p">[</span><span class="s2">&quot;phantomjs.page.settings.userAgent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/53 &quot;</span>
            <span class="s2">&quot;(KHTML, like Gecko) Chrome/15.0.87&quot;</span>
        <span class="p">)</span>
        <span class="c1"># DesiredCapabilities.PHANTOMJS[&#39;phantomjs.page.settings.userAgent&#39;] = user_agent</span>
        <span class="n">service_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;--proxy=127.0.0.1:8118&#39;</span><span class="p">,</span>  <span class="c1"># provixy proxy</span>
            <span class="s1">&#39;--proxy-type=http&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">use_tor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">PhantomJS</span><span class="p">(</span>
                <span class="s1">&#39;phantomjs&#39;</span><span class="p">,</span> <span class="n">service_args</span><span class="o">=</span><span class="n">service_args</span><span class="p">,</span> <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">dcap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">PhantomJS</span><span class="p">(</span>
                <span class="s1">&#39;phantomjs&#39;</span><span class="p">,</span> <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">dcap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">set_page_load_timeout</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">page_source</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%d</span><span class="s1"> request timeout&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</code></pre></div>

<p>At this point, the stack has blown quite a bit from a native Python urllib
to now <strong>Python+Java+Javascript</strong> and a third party web proxy tool.
The downside was apparently the complexity. But the upside was also obvious.
I have achieved a better control over our data harvesting process.
More importantly, we tried our best to be a good web citizen, and let's stick
to that.</p>
<h1>Final design</h1>
<p>After all the tweaks, the final design of my crawler comes down to this:</p>
<figure class="s12 center">
  <img src="images/crawler.jpg"/>
  <figcaption>Crawler architecture</figcaption>
</figure></p>

      <p>
        &mdash; by
        <a href="feng-xia.html">Feng Xia</a>
      </p>
    </div>
  </div>

</article>



          <div id="related">
          </div>
        </div>
      </div>
    </div>

    <footer class="split-screen">
      <div class="container">
        <h5>Categories:</h5>
        <a href="https://fengxia41103.github.io/myblog/demo.html">
          <i class="fa fa-folder-open-o"></i>
          demo
        </a>
        <a href="https://fengxia41103.github.io/myblog/dev.html">
          <i class="fa fa-folder-open-o"></i>
          dev
        </a>
        <a href="https://fengxia41103.github.io/myblog/fashion.html">
          <i class="fa fa-folder-open-o"></i>
          fashion
        </a>
        <a href="https://fengxia41103.github.io/myblog/gkp.html">
          <i class="fa fa-folder-open-o"></i>
          gkp
        </a>
        <a href="https://fengxia41103.github.io/myblog/lenovo.html">
          <i class="fa fa-folder-open-o"></i>
          lenovo
        </a>
        <a href="https://fengxia41103.github.io/myblog/odoo.html">
          <i class="fa fa-folder-open-o"></i>
          odoo
        </a>
        <a href="https://fengxia41103.github.io/myblog/openstack.html">
          <i class="fa fa-folder-open-o"></i>
          openstack
        </a>
        <a href="https://fengxia41103.github.io/myblog/pm.html">
          <i class="fa fa-folder-open-o"></i>
          pm
        </a>
        <a href="https://fengxia41103.github.io/myblog/react.html">
          <i class="fa fa-folder-open-o"></i>
          REACT
        </a>
        <a href="https://fengxia41103.github.io/myblog/rh.html">
          <i class="fa fa-folder-open-o"></i>
          rh
        </a>
        <a href="https://fengxia41103.github.io/myblog/stock.html">
          <i class="fa fa-folder-open-o"></i>
          stock
        </a>
        <a href="https://fengxia41103.github.io/myblog/thoughts.html">
          <i class="fa fa-folder-open-o"></i>
          thoughts
        </a>

        <h5>Tags:</h5>
        <a href="https://fengxia41103.github.io/myblog/tag-thoughts.html">
          <i class="fa fa-tag"></i>
          thoughts
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-dev.html">
          <i class="fa fa-tag"></i>
          dev
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-react.html">
          <i class="fa fa-tag"></i>
          react
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-love.html">
          <i class="fa fa-tag"></i>
          love
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-lenovo.html">
          <i class="fa fa-tag"></i>
          lenovo
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-angular.html">
          <i class="fa fa-tag"></i>
          angular
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-feng.html">
          <i class="fa fa-tag"></i>
          feng
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-design.html">
          <i class="fa fa-tag"></i>
          design
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-family.html">
          <i class="fa fa-tag"></i>
          family
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-demo.html">
          <i class="fa fa-tag"></i>
          demo
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-odoo.html">
          <i class="fa fa-tag"></i>
          odoo
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-fashion.html">
          <i class="fa fa-tag"></i>
          fashion
        </a>
        <a href="https://fengxia41103.github.io/myblog/tag-gkp.html">
          <i class="fa fa-tag"></i>
          gkp
        </a>
        <div class="">
          <h5>Show Cases:</h5>
          <div id="showcase">
            <p>
              Photo album:
              <a href="https://fengxia41103.github.io/moment/1236/#/">1236</a>
            </p>
            <p>
              API & charts:
              <a href="http://sp500chart.s3-website-us-east-1.amazonaws.com"
                >SP500</a
              >
            </p>
            <p>
              API & charts:
              <a
                href="http://snapshots.world.s3-website.ap-northeast-2.amazonaws.com/"
                >Snapshot of The World</a
              >
            </p>

            <p>
              Django (in Chinese):
              <a href="https://fengxia41103.github.io/myblog/project gkp demo.html">GKP</a>
            </p>
            <p>
              ERP:
              <a href="https://fengxia41103.github.io/myblog/project fashion demo.html">Fashion</a>
            </p>
            <p>
              Data processing:
              <a href="https://fengxia41103.github.io/myblog/project stock demo.html">Stock</a>
            </p>
            <p>
              Angular & REACT:
              <a href="https://fengxia41103.github.io/myblog/car leasing.html">Car leasing</a>
              &nbsp;|&nbsp;
              <a href="https://fengxia41103.github.io/spa-dashboard/">
                YAML Config Dashboard
              </a>
            </p>
            <p>
              API & REACT:
              <a href="https://fengxia41103.github.io/movie/">Movies</a>
            </p>
          </div>
        </div>
      </div>
      <video autoplay muted loop id="myVideo">
        <source src="downloads/polina.mp4" type="video/mp4" />
      </video>
    </footer>
    <div class="footer-copyright">
      <div class="container">
        <div class="row">
          <div class="col l8 m8 s12">
            <p>
              2016-2022 PY Consulting Ltd. 601 W. Rosemary St., Chapel Hill, NC 27516
            </p>

            <p>
              <a href="mailto:feng_xia41103@hotmail.com">
                <i class="fa fa-envelope"></i>
              </a>

              <a href="http://github.com/fengxia41103">
                <i class="fa fa-github"></i>
              </a>

              <a href="https://www.linkedin.com/in/fengxia41103">
                <i class="fa fa-linkedin"></i>
              </a>

              <a href="">
                <i class="fa fa-phone-square"></i>
                (508)801-1794
              </a>
            </p>
          </div>
          <div class="col l4 m4 s12">
            <p class="right">
              <i class="fa fa-copyright"></i>
              All rights reserved.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- end of block main -->

    <!-- Placed at the end of the document so the pages load faster -->

    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/js/materialize.min.js"
    ></script>

    <script
      type="text/javascript"
      src="https://fengxia41103.github.io/myblog/theme/js/bundle.js"
    ></script>

    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"
    ></script>

    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/lisp.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/xml.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/diff.min.js"
    ></script>

    <script type="text/javascript">
     var exports = {};
     var j$ = jQuery.noConflict();

     j$(document).ready(function () {
       // highlight.js initialization
       hljs.initHighlightingOnLoad();
       j$("pre").each(function (i, block) {
         hljs.highlightBlock(block);
       });

       // tooltips
       j$('[data-toggle="tooltip"]').tooltip();

       // image materialbox
       j$(".materialboxed").materialbox();
     });
    </script>
    <!-- end of block JS -->

  </body>
</html>